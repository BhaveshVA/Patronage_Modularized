name: Mirror main to VA GHE (SSH, force overwrite)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: mirror-to-ghe-main
  cancel-in-progress: true

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git identity
        run: |
          git config user.name "BhaveshVA"
          git config user.email "bhavesh.patel3@va.gov"

      - name: Setup SSH for VA GHE
        env:
          GHE_SSH_KEY: ${{ secrets.GHE_SSH_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$GHE_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          chmod 700 ~/.ssh
          ssh-keyscan -H va.ghe.com >> ~/.ssh/known_hosts

      - name: Add VA GHE remote (SSH)
        shell: bash
        run: |
          git remote remove ghe 2>/dev/null || true
          git remote add ghe git@va.ghe.com:software/Patronage_Modularized.git

      - name: Force mirror main -> main on GHE
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "+refs/heads/main:refs/remotes/origin/main"
          git push --force ghe "origin/main:refs/heads/main"

      # Optional: mirror tags too
      # - name: Mirror tags to GHE (force)
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     git fetch --tags origin
      #     git push --force ghe --tags
